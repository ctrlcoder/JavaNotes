## 消息队列

### 消息队列的使用场景

- **应用解耦** ：不关心处理

  多应用间通过消息队列对同一消息进行处理，避免调用接口失败导致整个过程失败；

- **异步处理**：并行，提速

  多应用对消息队列中同一消息进行处理，应用间并发处理消息，相比串行处理，减少处理时间；

- **流量削峰**：缓冲，秒杀

  通过异步处理，将短时间高并发产生的事务消息存储在消息队列中，从而削平高峰期的并发事务。

### 消息队列的带来的问题

- **系统可用性降低：**考虑消息丢失或者说MQ挂掉等等的情况
- **系统复杂性提高：** 会出现重复消费、处理消息丢失的情况、保证消息传递的顺序性等问题！
- **一致性问题：** 消息的消费者并没有正确消费消息就会导致数据不一致的情况了

### JMS和AMQP

### 1. 点对点模型（P2P）

- 使用**队列（Queue）**作为消息通信载体；满足**生产者与消费者模式**，一条消息只能被一个消费者使用，未被消费的消息在队列中保留直到被消费或超时。

> 如果希望每个消息都会被成功处理，使用P2P模型

### 2. 发布/订阅模型（Pub/Sub）

- 发布订阅模型（Pub/Sub） 使用**主题（Topic）**作为消息通信载体，类似于**广播模式**；发布者发布一条消息，该消息通过主题传递给所有的订阅者，**在一条消息广播之后才订阅的用户则是收不到该条消息的**。

> 如果希望发送的消息可以被多个消费者处理的话，那么可以采用Pub/Sub模式。





### 如何保证消息不被重复消费

Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，每隔一段时间（定时定期），会把自己消费过的消息的 offset 提交一下，表示“我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。

**消费者offset没来得及提交就会造成重复消费**

幂等性，通俗点说，就一个数据，或者一个请求，给你重复来多次，你得确保对应的数据是不会改变的，不能出错。

**怎么保证消息队列消费的幂等性？**

要保证消息的幂等性，这个要结合业务的类型来进行处理。下面提供几个思路供参考：

- 可在内存中维护一个set，只要从消息队列里面获取到一个消息，先查询这个消息在不在set里面，如果在表示已消费过，直接丢弃；如果不在，则在消费后将其加入set当中。
- 如何要写数据库，可以拿唯一键先去数据库查询一下，如果不存在在写，如果存在直接更新或者丢弃消息。
- 如果是写redis那没有问题，每次都是set，天然的幂等性。
- 让生产者发送消息时，每条消息加一个全局的唯一id，然后消费时，将该id保存到redis里面。消费时先去redis里面查一下有么有，没有再消费。
- 数据库操作可以设置唯一键，防止重复数据的插入，这样插入只会报错而不会插入重复数据。